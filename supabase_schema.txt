-- =================================================================
-- SITE EDITOR & LAYOUT MANAGEMENT - NEW SCHEMA
-- =================================================================
-- Run the following SQL in your Supabase SQL Editor to add the
-- Site Editor functionality to your existing database.

-- 1. Create the new 'site_layout' table
CREATE TABLE IF NOT EXISTS public.site_layout (
  id bigint GENERATED BY DEFAULT AS IDENTITY NOT NULL,
  created_at timestamp with time zone NULL DEFAULT now(),
  section_id text NOT NULL,
  sort_order integer NOT NULL,
  CONSTRAINT site_layout_pkey PRIMARY KEY (id)
);

-- 2. Enable Row Level Security (RLS) for the new table
ALTER TABLE public.site_layout ENABLE ROW LEVEL SECURITY;

-- 3. Create policies for the new 'site_layout' table
DROP POLICY IF EXISTS "Enable public read for site layout" ON public.site_layout;
CREATE POLICY "Enable public read for site layout" ON public.site_layout
  FOR SELECT USING (true);

DROP POLICY IF EXISTS "Enable admin full access for site layout" ON public.site_layout;
CREATE POLICY "Enable admin full access for site layout" ON public.site_layout
  FOR ALL USING (true);

-- 4. Populate the site_layout table with a default layout
-- This ensures the site works immediately.
-- It will delete any existing layout data to prevent duplicates.
DELETE FROM public.site_layout;
INSERT INTO public.site_layout (section_id, sort_order) VALUES
  ('recent_projects', 0),
  ('work_experience', 1),
  ('blog', 2),
  ('connect', 3);


-- =================================================================
-- OPTIONAL: PROJECT PAGE UPGRADE (Run if you haven't already)
-- =================================================================
-- If you haven't upgraded your 'projects' table for detailed
-- project pages yet, uncomment and run these commands.

-- ALTER TABLE public.projects ADD COLUMN IF NOT EXISTS slug TEXT;
-- ALTER TABLE public.projects ADD COLUMN IF NOT EXISTS content TEXT;
-- ALTER TABLE public.projects ADD COLUMN IF NOT EXISTS goals_challenges TEXT;
-- ALTER TABLE public.projects ADD COLUMN IF NOT EXISTS outcome TEXT;
-- ALTER TABLE public.projects ADD COLUMN IF NOT EXISTS tech_stack TEXT[];
-- ALTER TABLE public.projects DROP COLUMN IF EXISTS description;
